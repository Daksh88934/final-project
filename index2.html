<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Farming Assistant</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f9f4; }
    .section-title { font-size: 1.5rem; color: #2d5a2d; margin-bottom: 10px; }
    .detect-location-btn { padding: 10px 15px; border: none; border-radius: 6px; background: #2d5a2d; color: #fff; cursor: pointer; }
    .info-grid { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px; }
    .info-card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); flex: 1; min-width: 250px; }
    .card-title { font-weight: bold; margin-bottom: 8px; color: #444; }
    ul { margin: 0; padding-left: 20px; }
    .hidden { display: none; }

    /* Weather card styles from wheather.html */
    .dashboard {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 30px;
      width: 400px;
      animation: fadeIn 1.5s ease-in-out;
      margin: 10px auto 0;
    }
    .card { display: flex; align-items: center; gap: 15px; padding: 15px; border-radius: 15px; background: #f0f4ff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.3s ease; }
    .card:hover { transform: scale(1.05); }
    .icon { font-size: 2.5rem; animation: float 2s ease-in-out infinite; }
    .info { display: flex; flex-direction: column; }
    .label { font-weight: bold; font-size: 1rem; color: #333; }
    .value { font-size: 1.2rem; color: #555; }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <div class="helper-section">
    <h2 id="sectionTitle" class="section-title">Smart Farming Assistant</h2>
    <button id="detectBtn" class="detect-location-btn">üìç Detect My Location</button>
    
    <div class="info-grid">
      <div class="info-card weather-info">
        <div id="weatherTitle" class="card-title">Weather In Your Area</div>
        <div id="weatherData">
          <p>Click "Detect My Location" to get weather updates</p>
        </div>
      </div>

      <div class="info-card crop-recommendation">
        <div id="recTitle" class="card-title">Recommendations</div>
        <div id="cropRecommendations" class="hidden"></div>
      </div>
    </div>
  </div>

  <script type="module">
    const WEATHER_API_KEY = "f63434267eaeefb3ba598f95276a07da";

    async function getUserLocation() {
      return new Promise((resolve) => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
            async () => {
              try {
                const ipRes = await fetch("https://ipapi.co/json/");
                const ipData = await ipRes.json();
                resolve({ lat: ipData.latitude, lon: ipData.longitude });
              } catch (_) {
                resolve(null);
              }
            },
            { enableHighAccuracy: true, timeout: 10000 }
          );
        } else {
          fetch("https://ipapi.co/json/")
            .then(res => res.json())
            .then(ipData => resolve({ lat: ipData.latitude, lon: ipData.longitude }))
            .catch(() => resolve(null));
        }
      });
    }

    async function fetchWeather(location) {
      if (!location) return null;
      const url = `https://api.openweathermap.org/data/2.5/weather?lat=${location.lat}&lon=${location.lon}&units=metric&appid=${WEATHER_API_KEY}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.cod === 401) return null;
        return {
          city: data.name,
          temp: data.main?.temp != null ? Math.round(data.main.temp) : "N/A",
          humidity: data.main?.humidity,
          wind: data.wind?.speed ? Math.round(data.wind.speed * 3.6) : null,
          desc: data.weather?.[0]?.description,
          time: new Date().toLocaleTimeString()
        };
      } catch {
        return null;
      }
    }

    function renderWeather(weather) {
      const weatherDiv = document.getElementById("weatherData");
      if (!weather) {
        weatherDiv.innerHTML = "<p>Error loading weather data.</p>";
        return;
      }
      weatherDiv.innerHTML = `
        <div class="dashboard">
          <div class="card">
            <div class="icon">‚òÄÔ∏è</div>
            <div class="info">
              <div class="label">Temperature</div>
              <div class="value">${weather.temp}¬∞C</div>
            </div>
          </div>
          <div class="card">
            <div class="icon">üíß</div>
            <div class="info">
              <div class="label">Humidity</div>
              <div class="value">${weather.humidity}%</div>
            </div>
          </div>
          <div class="card">
            <div class="icon">üå¨Ô∏è</div>
            <div class="info">
              <div class="label">Wind Speed</div>
              <div class="value">${weather.wind} km/h</div>
            </div>
          </div>
          <div class="card">
            <div class="icon">üåßÔ∏è</div>
            <div class="info">
              <div class="label">Condition</div>
              <div class="value">${weather.desc || ''}</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderRecommendations(weather) {
      const recDiv = document.getElementById("cropRecommendations");
      if (!weather) {
        recDiv.innerHTML = "<p>No recommendations available.</p>";
        recDiv.classList.remove("hidden");
        return;
      }

      let crops = [];
      if (weather.temp >= 20 && weather.temp <= 30 && weather.humidity > 50) {
        crops.push("üåæ Rice", "üåΩ Maize", "ü•í Cucumbers");
      } else if (weather.temp > 30) {
        crops.push("üåª Sunflower", "üçâ Watermelon", "ü•≠ Mango");
      } else if (weather.temp < 20) {
        crops.push("ü•î Potato", "ü•¨ Spinach", "ü•¶ Broccoli");
      } else {
        crops.push("üçÖ Tomato", "ü•ú Groundnut", "üçÜ Brinjal");
      }

      recDiv.innerHTML = `
        <h4 style="color:#2d5a2d;">Recommended Crops for ${weather.city}:</h4>
        <ul>
          ${crops.map(c => `<li>${c}</li>`).join("")}
        </ul>
      `;
      recDiv.classList.remove("hidden");
    }

    async function detectLocation() {
      const location = await getUserLocation();
      const weather = await fetchWeather(location);
      renderWeather(weather);
      renderRecommendations(weather);
    }

    // Bind button
    document.getElementById("detectBtn").addEventListener("click", detectLocation);
  </script>
</body>
</html>
